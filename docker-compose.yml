version: '3.8'

services:
  # Flask app
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: transformer_app
    ports:
      - "5000:5000"
    volumes:
      - ./models:/app/models
      - ./runs:/app/runs
      - ./logs:/app/logs
    environment:
      FLASK_APP: app.py
      FLASK_ENV: development
    restart: always

  # Airflow service
  airflow:
    build:
      context: .
      dockerfile: Dockerfile.airflow
    container_name: transformer_airflow
    ports:
      - "8080:8080"
      - "5555:5555"
    volumes:
      - ./dags:/opt/airflow/dags
      - ./logs:/opt/airflow/logs
      - ./models:/opt/airflow/models
      - ./runs:/opt/airflow/runs
    environment:
      AIRFLOW__CORE__LOAD_EXAMPLES: 'false'
      AIRFLOW__CORE__LOAD_DEFAULT_CONNECTIONS: 'false'
    restart: always

  # TensorBoard for visualization
  tensorboard:
    image: tensorflow/tensorflow:latest
    container_name: transformer_tensorboard
    command: tensorboard --logdir=/logs --host=0.0.0.0 --port=6006
    volumes:
      - ./runs:/logs
    ports:
      - "6006:6006"
    restart: always

volumes:
  postgres-db-volume:

networks:
  airflow-network:
    driver: bridge


